# í† í° ì‚¬ìš©ëŸ‰ ë¶„ì„ ë° ìµœì í™” ë°©ì•ˆ

## ğŸ” í˜„ì¬ ìƒíƒœ ë¶„ì„

### 1. maxTokens ì„¤ì • í™•ì¸

| API | maxTokens | ì‹¤ì œ í•„ìš”ëŸ‰ | ë¬¸ì œì  |
|-----|-----------|------------|--------|
| **Classification** | 10 | ~5 tokens | âœ… ì ì ˆ |
| **Chat API** | 700 | ~150 tokens (200ì) | âŒ **ê³¼ë„í•¨ (4.7ë°°)** |

**ë¬¸ì œ:**
- Chat APIì˜ maxTokensê°€ 700ì¸ë°, ì‹¤ì œë¡œëŠ” 200ì ì´ë‚´ ë‹µë³€ë§Œ í•„ìš”
- 200ì â‰ˆ ~150 tokens
- **ë¶ˆí•„ìš”í•œ í† í° ì˜ˆì•½: 550 tokens**

### 2. ì§ˆë¬¸ ì„±ê²©ë³„ ë¡œì§ í™•ì¸

#### âœ… ì„ë² ë”© (Embedding) - ì˜¬ë°”ë¥´ê²Œ êµ¬í˜„ë¨
```typescript
// ì •ë³´ ìš”êµ¬ ì§ˆë¬¸ì¸ ê²½ìš°ì—ë§Œ ì„ë² ë”© ë° RAG ê²€ìƒ‰ ìˆ˜í–‰
if (isInfoRequest) {
  const qEmb = await embedText(question);
  // RAG ê²€ìƒ‰ ìˆ˜í–‰
}
```
- âœ… ì •ë³´ì„± ì§ˆë¬¸ì¼ ë•Œë§Œ Embedding API í˜¸ì¶œ
- âœ… ë¹„ì •ë³´ì„± ì§ˆë¬¸ì¼ ë•ŒëŠ” Embedding í˜¸ì¶œ ì•ˆ í•¨

#### âŒ íˆìŠ¤í† ë¦¬ (History) - ë¬¸ì œ ìˆìŒ
```typescript
const messages = [
  {
    role: "system",
    content: activeSystemPrompt,
  },
  ...history, // âš ï¸ ëª¨ë“  ì´ì „ ëŒ€í™” ë¬´ì¡°ê±´ í¬í•¨
  {
    role: "user",
    content: userMessageContent,
  },
];
```
- âŒ **ì§ˆë¬¸ ì„±ê²©ê³¼ ê´€ê³„ì—†ì´ ëª¨ë“  ì´ì „ ëŒ€í™” í¬í•¨**
- âŒ History ì œí•œ ì—†ìŒ (ë¬´ì œí•œ ëˆ„ì )
- âŒ ë¹„ì •ë³´ì„± ì§ˆë¬¸ì—ë„ ì´ì „ ì •ë³´ì„± ì§ˆë¬¸ì˜ ê¸´ RAG context í¬í•¨

---

## ğŸš¨ ì£¼ìš” ë¬¸ì œì 

### 1. maxTokens ê³¼ë‹¤ ì„¤ì •
- **í˜„ì¬**: 700 tokens
- **í•„ìš”**: ~150 tokens (200ì)
- **ë‚­ë¹„**: 550 tokens Ã— 6íšŒ = 3,300 tokens

### 2. History ë¬´ì œí•œ ëˆ„ì 
- ëª¨ë“  ì´ì „ ëŒ€í™”ê°€ í¬í•¨ë¨
- 6ë²ˆì§¸ ì§ˆë¬¸ ì‹œ: ì´ì „ 5í„´ì˜ ëª¨ë“  ëŒ€í™” í¬í•¨
- ì •ë³´ì„± ì§ˆë¬¸ì˜ RAG contextê¹Œì§€ ëª¨ë‘ í¬í•¨

### 3. System Prompt ê³¼ë‹¤
- 6,424 bytes â‰ˆ ~3,500 tokens
- ë§¤ ì§ˆë¬¸ë§ˆë‹¤ ë°˜ë³µ í¬í•¨
- 6ë²ˆ Ã— 3,500 = 21,000 tokens

---

## ğŸ’¡ ìµœì í™” ë°©ì•ˆ

### ë°©ì•ˆ 1: maxTokens ìµœì í™” (ì¦‰ì‹œ ì ìš© ê°€ëŠ¥) â­â­â­

**í˜„ì¬:**
```typescript
maxTokens: 700
```

**ê°œì„ :**
```typescript
maxTokens: 200  // 200ì â‰ˆ ~150 tokens + ì—¬ìœ  50 tokens
```

**íš¨ê³¼:**
- 6íšŒ Ã— 500 tokens ì ˆê° = **3,000 tokens ì ˆê°**
- ë¹„ìš© ì•½ 8% ê°ì†Œ

### ë°©ì•ˆ 2: History ì œí•œ (ì¦‰ì‹œ ì ìš© ê°€ëŠ¥) â­â­â­

**í˜„ì¬:**
```typescript
...history, // ëª¨ë“  ì´ì „ ëŒ€í™”
```

**ê°œì„ :**
```typescript
// ìµœê·¼ 2í„´ë§Œ í¬í•¨ (ë˜ëŠ” ìµœê·¼ 3í„´)
const recentHistory = history.slice(-4); // ìµœê·¼ 2í„´ (user+assistant ìŒ)
...recentHistory,
```

**íš¨ê³¼:**
- 6ë²ˆì§¸ ì§ˆë¬¸ ì‹œ: ~3,200 tokens â†’ ~800 tokens
- **ì•½ 2,400 tokens ì ˆê°**
- ë¹„ìš© ì•½ 6% ê°ì†Œ

### ë°©ì•ˆ 3: ì§ˆë¬¸ ì„±ê²©ë³„ History í•„í„°ë§ (ì¶”ì²œ) â­â­

**í˜„ì¬:**
- ë¹„ì •ë³´ì„± ì§ˆë¬¸ì—ë„ ì´ì „ ì •ë³´ì„± ì§ˆë¬¸ì˜ RAG context í¬í•¨

**ê°œì„ :**
```typescript
// ë¹„ì •ë³´ì„± ì§ˆë¬¸ì¼ ë•ŒëŠ” RAG context ì œê±°
const filteredHistory = isInfoRequest 
  ? history  // ì •ë³´ì„± ì§ˆë¬¸: ëª¨ë“  history í¬í•¨
  : history.map(msg => {
      // ë¹„ì •ë³´ì„± ì§ˆë¬¸: RAG context ì œê±°
      if (msg.role === 'user' && msg.content.includes('[ì°¸ê³  ê°€ëŠ¥í•œ ì´ë²¤íŠ¸]')) {
        // RAG context ë¶€ë¶„ë§Œ ì œê±°
        const withoutContext = msg.content.split('\n\n[ì°¸ê³  ê°€ëŠ¥í•œ ì´ë²¤íŠ¸]')[0] + 
                               msg.content.split('ìœ„ ì •ë³´ë§Œ ì‚¬ìš©í•´')[1] || '';
        return { ...msg, content: withoutContext };
      }
      return msg;
    });

const messages = [
  { role: "system", content: activeSystemPrompt },
  ...filteredHistory,
  { role: "user", content: userMessageContent },
];
```

**íš¨ê³¼:**
- ë¹„ì •ë³´ì„± ì§ˆë¬¸ ì‹œ RAG context ì œê±°
- **ì•½ 2,400 tokens ì ˆê°** (3ë²ˆì˜ ë¹„ì •ë³´ì„± ì§ˆë¬¸)
- ë¹„ìš© ì•½ 6% ê°ì†Œ

### ë°©ì•ˆ 4: System Prompt ìµœì í™” (ì¤‘ê¸°) â­

**í˜„ì¬:**
- 6,424 bytes â‰ˆ ~3,500 tokens

**ê°œì„ :**
- ë¶ˆí•„ìš”í•œ ì˜ˆì‹œ ëŒ€í™” ì œê±°
- í•µì‹¬ ê·œì¹™ë§Œ ìœ ì§€
- ëª©í‘œ: ~2,000 tokens

**íš¨ê³¼:**
- 6íšŒ Ã— 1,500 tokens ì ˆê° = **9,000 tokens ì ˆê°**
- ë¹„ìš© ì•½ 23% ê°ì†Œ

### ë°©ì•ˆ 5: RAG Context ì••ì¶• (ì„ íƒì‚¬í•­) â­

**í˜„ì¬:**
- TOP_K = 3
- ê° ì´ë²¤íŠ¸ì˜ ì „ì²´ í…ìŠ¤íŠ¸ í¬í•¨

**ê°œì„ :**
```typescript
// TOP_Kë¥¼ 3ì—ì„œ 2ë¡œ ê°ì†Œ
const TOP_K = 2;

// ë˜ëŠ” Context ìš”ì•½
const summarizedContext = await summarizeContext(context);
```

**íš¨ê³¼:**
- ~800 tokens â†’ ~500 tokens
- 3ë²ˆ Ã— 300 tokens = **900 tokens ì ˆê°**
- ë¹„ìš© ì•½ 2% ê°ì†Œ

---

## ğŸ“Š ìµœì í™” íš¨ê³¼ ì˜ˆìƒ

### í˜„ì¬ (38,580 tokens)
- Classification: 1,530
- Embedding: 90
- Chat API: 36,960

### ìµœì í™” í›„ (ì˜ˆìƒ)

#### ìµœì†Œ ìµœì í™” (ë°©ì•ˆ 1 + 2)
- maxTokens: 700 â†’ 200
- History: ë¬´ì œí•œ â†’ ìµœê·¼ 2í„´
- **ì˜ˆìƒ: ~28,000 tokens** (27% ê°ì†Œ)

#### ê¶Œì¥ ìµœì í™” (ë°©ì•ˆ 1 + 2 + 3)
- maxTokens: 700 â†’ 200
- History: ë¬´ì œí•œ â†’ ìµœê·¼ 2í„´
- ë¹„ì •ë³´ì„± ì§ˆë¬¸: RAG context ì œê±°
- **ì˜ˆìƒ: ~25,000 tokens** (35% ê°ì†Œ)

#### ìµœëŒ€ ìµœì í™” (ë°©ì•ˆ 1 + 2 + 3 + 4)
- ìœ„ ëª¨ë“  ë°©ì•ˆ + System Prompt ìµœì í™”
- **ì˜ˆìƒ: ~16,000 tokens** (59% ê°ì†Œ)

---

## ğŸ¯ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ìµœì í™” (ìš°ì„ ìˆœìœ„)

### 1ìˆœìœ„: maxTokens ì¡°ì • â­â­â­
```typescript
// src/app/api/chat/route.ts:975
maxTokens: 200,  // 700 â†’ 200
```
**íš¨ê³¼**: 3,000 tokens ì ˆê°

### 2ìˆœìœ„: History ì œí•œ â­â­â­
```typescript
// src/app/api/chat/route.ts:964
const recentHistory = history.slice(-4); // ìµœê·¼ 2í„´ë§Œ
...recentHistory,
```
**íš¨ê³¼**: 2,400 tokens ì ˆê°

### 3ìˆœìœ„: ë¹„ì •ë³´ì„± ì§ˆë¬¸ History í•„í„°ë§ â­â­
```typescript
// RAG context ì œê±° ë¡œì§ ì¶”ê°€
```
**íš¨ê³¼**: 2,400 tokens ì ˆê°

---

## ğŸ’° ë¹„ìš© ì ˆê° íš¨ê³¼

### í˜„ì¬
- ì„¸ì…˜ë‹¹: ~38,580 tokens â‰ˆ **$0.05**

### ìµœì†Œ ìµœì í™” í›„
- ì„¸ì…˜ë‹¹: ~28,000 tokens â‰ˆ **$0.036** (28% ì ˆê°)

### ê¶Œì¥ ìµœì í™” í›„
- ì„¸ì…˜ë‹¹: ~25,000 tokens â‰ˆ **$0.032** (36% ì ˆê°)

### ìµœëŒ€ ìµœì í™” í›„
- ì„¸ì…˜ë‹¹: ~16,000 tokens â‰ˆ **$0.021** (58% ì ˆê°)

---

## âœ… ê²°ë¡ 

**í˜„ì¬ ë¬¸ì œ:**
1. âŒ maxTokens ê³¼ë‹¤ (700 â†’ 200 ê¶Œì¥)
2. âŒ History ë¬´ì œí•œ ëˆ„ì 
3. âŒ ë¹„ì •ë³´ì„± ì§ˆë¬¸ì—ë„ RAG context í¬í•¨

**ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ìµœì í™”:**
1. maxTokens: 700 â†’ 200
2. History: ìµœê·¼ 2í„´ë§Œ í¬í•¨
3. ë¹„ì •ë³´ì„± ì§ˆë¬¸: RAG context ì œê±°

**ì˜ˆìƒ íš¨ê³¼:**
- í† í° ì‚¬ìš©ëŸ‰: 38,580 â†’ ~25,000 tokens (35% ê°ì†Œ)
- ë¹„ìš©: $0.05 â†’ $0.032 per session (36% ì ˆê°)

