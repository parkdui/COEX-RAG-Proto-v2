# 🚀 토큰 최적화 v2 - 대폭 절감

## 📊 최적화 결과

### Before (최적화 전)
- System Prompt: 약 3,019자 → **약 4,200-4,500 tokens**
- History: 최근 2턴 (4개 메시지)
- RAG Context: 각 이벤트 200자
- **세션당 총 토큰**: 10,000+ tokens

### After (최적화 후)
- System Prompt: 약 1,300자 → **약 1,800-2,000 tokens** (약 50% 절감)
- History: 최근 1턴 (2개 메시지) (50% 절감)
- RAG Context: 각 이벤트 100자 (50% 절감)
- User Message 프롬프트 간소화
- **예상 세션당 총 토큰**: 약 4,000-5,000 tokens (약 50-60% 절감)

## 🔧 주요 변경 사항

### 1. System Prompt 최적화
- ✅ 예시 대화: 2개 → 1개로 축소
- ✅ 예시 대화 내용 간소화 (전체 대화 → 핵심만)
- ✅ 중복 설명 제거
- ✅ 날짜 정보 간소화: `[날짜] 2025년 01월 15일(수). 지나간 이벤트 추천 금지.`
- ✅ 응답 형식 규칙 간소화: `[응답] 첫 문장 24자 이내.`

**절감량**: 약 1,700자 → 약 2,400 tokens 절감

### 2. History 최적화 강화
- ✅ 최근 2턴 → **최근 1턴만 유지**
- ✅ 비정보성 질문 시 RAG context 제거 유지

**절감량**: 약 50% 절감

### 3. RAG Context 최적화
- ✅ 각 이벤트 텍스트: 200자 → **100자로 축소**
- ✅ 메타 정보 간소화 (지역 정보 제거)

**절감량**: 약 50% 절감

### 4. User Message 프롬프트 간소화
- Before: `질문: ${question}\n\n[참고 가능한 이벤트]\n${context}\n\n위 정보만 사용해 사용자 질문에 답하세요. 만약 [참고 가능한 이벤트]에 대한 정보를 묻지 않고 있다면, 대화 맥락과 system prompt에 따라 '질문'에 답하세요. 반드시 30자 이내로만 답하세요.`
- After: `질문: ${question}\n\n[참고 이벤트]\n${context}\n\n위 정보로 답하세요. 30자 이내.`

**절감량**: 약 100-150 tokens 절감

## 📝 상세 로깅 기능 추가

### 환경 변수 설정
```bash
LOG_API_INPUT=1  # API 호출 상세 로그
LOG_TOKENS=1     # 토큰 사용량 로그 (기존)
```

### 로그 출력 내용

#### 1. API 호출 전
```
================================================================================
📤 [API CALL] CLOVA Chat API 호출
================================================================================

📋 System Prompt 길이: 1300자 (약 1820 tokens)
📋 History 메시지 수: 2개
  [1] user: 질문: 안녕하세요... (50자)
  [2] assistant: 안녕하세요! 코엑스에 오신 것을 환영합니다... (80자)
📋 User Message: 질문: 추천해줘... (200자)
📋 총 메시지 수: 4개
📋 총 문자 수: 1630자 (약 2282 tokens 예상)
================================================================================
```

#### 2. API 응답 후
```
================================================================================
📥 [API RESPONSE] CLOVA Chat API 응답
================================================================================
💬 [CHAT] input=2300 output=45 total=2345
💬 [CHAT] 누적: input=2300 output=45 total=2345 (calls=1)
📝 [RESPONSE] 안녕하세요! 코엑스에 오신 것을 환영합니다...
================================================================================
```

#### 3. 토큰 요약
```
================================================================================
📊 [TOKEN SUMMARY] 이번 요청 토큰 사용량
================================================================================
🔍 Classification: 50 tokens (1 calls)
📦 Embedding: 120 tokens (1 calls)
💬 Chat: 2345 tokens (1 calls)
📊 총합: 2515 tokens
================================================================================
```

## 🎯 예상 절감 효과

### 시나리오: 6턴 대화

#### Before (최적화 전)
- System Prompt: 4,200 tokens × 6 = 25,200 tokens
- History (누적): 약 3,000 tokens
- RAG Context: 약 1,500 tokens × 3 = 4,500 tokens
- User Messages: 약 500 tokens × 6 = 3,000 tokens
- **총합**: 약 35,700 tokens

#### After (최적화 후)
- System Prompt: 2,000 tokens × 6 = 12,000 tokens
- History (누적): 약 1,000 tokens
- RAG Context: 약 600 tokens × 3 = 1,800 tokens
- User Messages: 약 300 tokens × 6 = 1,800 tokens
- **총합**: 약 16,600 tokens

**절감률**: 약 53% 절감

## 📋 사용 방법

### 1. 로컬 개발 시 로깅 활성화
```bash
# .env.local 파일에 추가
LOG_API_INPUT=1
LOG_TOKENS=1
```

### 2. Vercel 배포 시 로깅 활성화
Vercel 대시보드 → Settings → Environment Variables:
```
LOG_API_INPUT=1
LOG_TOKENS=1
```

### 3. 로그 확인
터미널 또는 Vercel 대시보드 → Functions → Logs에서 확인

## ✅ 체크리스트

- [x] System Prompt 최적화 (예시 대화 축소)
- [x] History 최적화 강화 (1턴만 유지)
- [x] RAG Context 최적화 (100자로 축소)
- [x] User Message 프롬프트 간소화
- [x] 상세 로깅 기능 추가
- [ ] 실제 테스트 및 검증

## 🔍 모니터링

배포 후 다음을 확인하세요:
1. 실제 토큰 사용량이 예상 범위 내인지 확인
2. 로그에서 각 요청의 토큰 사용량 확인
3. 세션당 총 토큰이 5,000 tokens 이하인지 확인

## 📝 참고사항

- 로깅은 `LOG_API_INPUT=1` 또는 `LOG_TOKENS=1` 설정 시에만 활성화됩니다
- 프로덕션 환경에서는 필요시에만 활성화하세요 (로그가 많아질 수 있음)
- 토큰 절감으로 인해 응답 품질이 약간 달라질 수 있으니 테스트 필요

