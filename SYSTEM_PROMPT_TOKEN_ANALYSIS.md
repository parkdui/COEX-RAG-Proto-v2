# System Prompt 토큰 사용량 분석

## 📊 구성 요소

### 1. 기본 System Prompt (`system_prompt.txt`)
- **실제 문자 수**: 2,809자
- 내용: 이솔(SORI) 캐릭터 설정, 말투, 대화 흐름, 예시 대화 등

### 2. 추가되는 텍스트

#### 현재 날짜 정보 (`currentDateInfo`)
```
[현재 날짜 정보]
현재 날짜는 2025년 01월 XX일(요일)이다. 지나간 날짜의 이벤트는 추천하지 않아야 한다.
```
- **실제 문자 수**: 약 60자

#### 응답 형식 규칙 (`headlineConstraint`)
```
[응답 형식 규칙]
응답의 첫 번째 문장(또는 첫 번째 문단)은 모바일 화면에서 최대 2줄로 표시될 수 있도록 작성해야 합니다. 한 줄은 약 12자 정도로 계산하여, 첫 번째 문장은 약 24자 이내로 작성하되, 문장이 자연스럽게 끝맺음되도록 해주세요.
```
- **실제 문자 수**: 약 100자

## 🔢 토큰 계산

### 한글 토큰화 특성
- **한글 1자**: 약 1.3 ~ 1.5 tokens
- **영어 1단어**: 약 1.3 tokens
- **숫자/기호**: 약 1 token

### 계산

#### 기본 System Prompt
- 문자 수: **2,809자**
- 토큰 수 (×1.4): 2,809 × 1.4 = **약 3,933 tokens**
- 토큰 수 (×1.5): 2,809 × 1.5 = **약 4,214 tokens**

#### 추가 텍스트
- 현재 날짜 정보: 60자 × 1.4 = **약 84 tokens**
- 응답 형식 규칙: 100자 × 1.4 = **약 140 tokens**

### 총 System Prompt 토큰
- **총 문자 수**: 약 2,969자
- **예상 토큰 수 (×1.4)**: **약 4,157 tokens**
- **예상 토큰 수 (×1.5)**: **약 4,454 tokens**

**실제 사용량**: **약 4,000-4,500 tokens** (매 요청마다)

## 📈 실제 사용량 확인 방법

### 방법 1: LOG_TOKENS 환경 변수 사용
```bash
LOG_TOKENS=1
```

배포 후 API 호출 시 로그에서 확인:
```
💬 [CHAT] in=XXXX out=XX total=XXXX
```
여기서 `in` 값이 prompt tokens입니다.

### 방법 2: Health API로 확인
실제 API 응답에서 `tokens.input` 값을 확인할 수 있습니다.

## 💡 최적화 가능 여부

### 현재 상태
- System Prompt: **약 4,000-4,500 tokens**
- 이는 **매우 큰 편**입니다. (일반적으로 500-1,500 tokens 권장)

### 최적화 방안

1. **예시 대화 축소**
   - 현재 2개의 긴 예시 대화 포함
   - 1개로 줄이거나 요약 가능
   - 절감: 약 1,000-1,500 tokens

2. **불필요한 설명 제거**
   - 중복되는 설명 정리
   - 절감: 약 200-300 tokens

3. **핵심만 유지**
   - 캐릭터 설정, 말투, 출력 규칙만 유지
   - 절감: 약 1,500-2,000 tokens

### 최적화 후 예상
- 최적화 후: 약 1,500-2,000 tokens
- 절감률: 약 50-60%
- **절감량**: 약 2,000-2,500 tokens (매 요청마다!)

## ⚠️ 주의사항

1. **System Prompt는 매 요청마다 전송됨**
   - History가 없을 때: System Prompt만
   - History가 있을 때: System Prompt + History

2. **토큰 비용**
   - System Prompt가 클수록 매 요청마다 많은 토큰 사용
   - 비용에 직접적인 영향

3. **성능**
   - System Prompt가 크면 처리 시간이 약간 증가할 수 있음
   - 하지만 큰 영향은 없음

## 📝 권장사항

현재 System Prompt 토큰 사용량이 **약 3,710 tokens**로 상당히 큽니다.

**최적화 권장**:
- 예시 대화를 1개로 축소하거나 요약
- 중복 설명 제거
- 핵심 내용만 유지

이렇게 하면 **약 50% 토큰 절감** 가능하며, 기능에는 큰 영향 없습니다.

