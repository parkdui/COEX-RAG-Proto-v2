# RAG Context 압축 가이드

## 📚 RAG Context란?

RAG Context는 사용자 질문에 관련된 이벤트 정보를 검색해서 AI에게 제공하는 참고 자료입니다.

### 현재 구조

```typescript
// TOP_K = 3 (상위 3개 검색 결과)
const ranked = scored.slice(0, TOP_K);

// Context 구성
context = slimHits.map((h, i) => {
  return (
    `[${i + 1}] ${m.title} | ${m.date} | ${m.venue} | 지역:${m.region} | 산업군:${m.industry}\n` +
    h.text  // ⚠️ 전체 텍스트 포함 (매우 길 수 있음)
  );
}).join("\n\n");
```

### 예시: 현재 RAG Context

```
[1] 코엑스 아쿠아리움 | 2025-01-15 | 코엑스 B1 | 지역:강남 | 산업군:엔터테인먼트
코엑스 아쿠아리움은 다양한 해양 생물을 관람할 수 있는 실내 수족관입니다. 
상어, 펭귄, 해파리 등 40,000마리 이상의 해양 생물을 만날 수 있으며, 
터널형 수조를 통해 물속을 걷는 듯한 경험을 할 수 있습니다. 
특히 상어 수조 옆 산책로는 로맨틱한 분위기를 연출하기 좋습니다.
입장료는 성인 28,000원, 청소년 25,000원입니다.
운영 시간은 평일 10:00-20:00, 주말 10:00-21:00입니다.

[2] 별마당 도서관 | 2025-01-20 | 코엑스 B1 | 지역:강남 | 산업군:문화
별마당 도서관은 13미터 높이의 거대한 책장과 함께 독서를 즐길 수 있는 공간입니다.
조용하고 분위기 있는 환경에서 책을 읽거나 작업할 수 있으며,
카페도 함께 운영되어 커피와 함께 독서를 즐길 수 있습니다.
무료로 이용 가능하며, 평일 오후에는 조용한 분위기를 즐길 수 있습니다.

[3] SM타운 코엑스아티움 | 2025-01-25 | 코엑스 1층 | 지역:강남 | 산업군:엔터테인먼트
SM 엔터테인먼트 소속 아티스트들의 테마 공간으로, 전시, 홀로그램 공연, 뮤지엄 등이 있습니다.
에스파, 뉴진스 등 인기 아이돌과 관련된 콘텐츠를 만날 수 있으며,
팬들을 위한 굿즈샵도 운영됩니다. 입장료는 성인 18,000원입니다.
```

**현재 토큰 수**: 약 800-1,000 tokens

---

## 🎯 RAG Context 압축이란?

**RAG Context 압축**은 Context에 포함되는 정보의 양을 줄여서 토큰 사용량을 감소시키는 방법입니다.

### 압축 방법

#### 1. TOP_K 감소 (가장 간단) ⭐⭐⭐
```typescript
// 현재: TOP_K = 3
// 압축: TOP_K = 2
const ranked = scored.slice(0, 2); // 3개 → 2개
```

**효과:**
- 3개 → 2개: 약 33% 감소
- 토큰 절감: ~800 tokens → ~530 tokens
- **약 270 tokens 절감**

**장점:**
- 구현 간단
- 즉시 적용 가능

**단점:**
- 관련 정보 손실 가능성

---

#### 2. 텍스트 길이 제한 (간단) ⭐⭐
```typescript
// 각 이벤트 텍스트를 200자로 제한
context = slimHits.map((h, i) => {
  const text = h.text.length > 200 
    ? h.text.substring(0, 200) + '...' 
    : h.text;
  
  return (
    `[${i + 1}] ${m.title} | ${m.date} | ${m.venue}\n` +
    text
  );
}).join("\n\n");
```

**효과:**
- 각 이벤트: ~300자 → 200자
- 토큰 절감: ~800 tokens → ~530 tokens
- **약 270 tokens 절감**

**장점:**
- 핵심 정보 유지
- 구현 간단

**단점:**
- 일부 상세 정보 손실

---

#### 3. 메타데이터만 포함 (강력한 압축) ⭐⭐⭐
```typescript
// 텍스트 제거, 메타데이터만 포함
context = slimHits.map((h, i) => {
  const m = h.meta || {};
  return (
    `[${i + 1}] ${m.title} | ${m.date} | ${m.venue}` +
    `${m.region ? " | 지역:" + m.region : ""}` +
    `${m.industry ? " | 산업군:" + m.industry : ""}`
    // h.text 제거!
  );
}).join("\n\n");
```

**효과:**
- 텍스트 제거로 대폭 감소
- 토큰 절감: ~800 tokens → ~100 tokens
- **약 700 tokens 절감**

**장점:**
- 매우 강력한 압축
- 토큰 대폭 절감

**단점:**
- 상세 정보 손실
- AI가 구체적인 정보를 모를 수 있음

---

#### 4. 텍스트 요약 (고급, 복잡) ⭐
```typescript
// 각 이벤트 텍스트를 요약 API로 압축
const summarizedText = await summarizeText(h.text); // 300자 → 100자
```

**효과:**
- 의미 유지하면서 길이 감소
- 토큰 절감: ~800 tokens → ~300 tokens

**장점:**
- 핵심 정보 유지
- 의미 손실 최소화

**단점:**
- 추가 API 호출 필요 (비용 증가)
- 구현 복잡
- 응답 시간 증가

---

#### 5. 관련 문장만 추출 (중급) ⭐⭐
```typescript
// 질문과 관련된 문장만 추출
const relevantSentences = extractRelevantSentences(h.text, question);
// 예: "식당 추천" 질문 → 식당 관련 문장만 추출
```

**효과:**
- 관련 정보만 포함
- 토큰 절감: ~800 tokens → ~400 tokens

**장점:**
- 관련성 높은 정보만 유지
- 불필요한 정보 제거

**단점:**
- 구현 복잡
- 문장 추출 로직 필요

---

## 📊 압축 방법별 비교

| 방법 | 토큰 절감 | 구현 난이도 | 정보 손실 | 추천도 |
|------|----------|------------|----------|--------|
| **TOP_K 3→2** | ~270 tokens | ⭐ 매우 쉬움 | 낮음 | ⭐⭐⭐ |
| **텍스트 길이 제한** | ~270 tokens | ⭐ 매우 쉬움 | 중간 | ⭐⭐ |
| **메타데이터만** | ~700 tokens | ⭐ 매우 쉬움 | 높음 | ⭐ (상황에 따라) |
| **텍스트 요약** | ~500 tokens | ⭐⭐⭐ 어려움 | 낮음 | ⭐ (비용 증가) |
| **관련 문장 추출** | ~400 tokens | ⭐⭐ 중간 | 낮음 | ⭐⭐ |

---

## 💡 권장 압축 방법

### 방법 1: TOP_K 감소 (가장 추천) ⭐⭐⭐
```typescript
// 환경 변수로 제어 가능
const TOP_K = parseInt(getEnv("TOP_K", "2"), 10); // 3 → 2
```

**효과:**
- 즉시 적용 가능
- 약 270 tokens 절감
- 정보 손실 최소화

### 방법 2: 텍스트 길이 제한 (추천) ⭐⭐
```typescript
const MAX_CONTEXT_LENGTH = 200; // 각 이벤트당 최대 200자

context = slimHits.map((h, i) => {
  const m = h.meta || {};
  const text = h.text.length > MAX_CONTEXT_LENGTH
    ? h.text.substring(0, MAX_CONTEXT_LENGTH) + '...'
    : h.text;
  
  return (
    `[${i + 1}] ${m.title} | ${m.date} | ${m.venue}\n` +
    text
  );
}).join("\n\n");
```

**효과:**
- 약 270 tokens 절감
- 핵심 정보 유지

### 방법 3: 둘 다 적용 (최대 압축) ⭐⭐⭐
```typescript
const TOP_K = 2; // 3 → 2
const MAX_CONTEXT_LENGTH = 150; // 각 이벤트당 150자

// 둘 다 적용하면 약 500-600 tokens 절감
```

---

## 🎯 예상 효과

### 현재 (TOP_K=3, 전체 텍스트)
- Context: ~800 tokens
- 3번의 정보성 질문 × 800 = 2,400 tokens

### 압축 후 (TOP_K=2, 200자 제한)
- Context: ~400 tokens
- 3번의 정보성 질문 × 400 = 1,200 tokens
- **절감: 1,200 tokens (50% 감소)**

### 세션당 총 토큰 절감
- 최적화 전: 38,580 tokens
- 최적화 후: ~23,370 tokens
- **추가 절감: 1,200 tokens**

---

## ✅ 결론

**RAG Context 압축이란:**
- 검색된 이벤트 정보의 양을 줄여서 토큰 사용량을 감소시키는 방법
- TOP_K 감소, 텍스트 길이 제한, 메타데이터만 사용 등 다양한 방법 존재

**가장 추천하는 방법:**
1. **TOP_K: 3 → 2** (간단하고 효과적)
2. **텍스트 길이 제한: 200자** (핵심 정보 유지)

**둘 다 적용 시:**
- 약 500-600 tokens 추가 절감 가능
- 세션당 총 토큰: ~23,000 tokens (40% 감소)

